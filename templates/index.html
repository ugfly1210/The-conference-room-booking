{% load staticfiles %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ä¼šè®®å®¤é¢„å®š</title>
    <link rel="stylesheet" href="{% static 'plugins/bootstrap/css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_234130_nem7eskcrkpdgqfr.css">
    <link rel="stylesheet" href="{% static 'plugins/schedule/schedule.css' %}">
    <style>
        #schedule-box {
            position: absolute;
            top: 43px;
            background-color: white;
            opacity: 0.7;
            border-radius: 5px;
        }

        * {
            font-family: "Comic Sans MS";
            text-align: center;
        }

        th {
            text-align: center;
        }

        td.chosen {
            background-color: #66afe9;
        }

        td.chosen_gun {
            background-color: #2b669a;
        }

        td.after_click {
            background-color: #28a4c9;
        }
    </style>
</head>
<body>


<div class="container">
    <h1 class="text-center " style="margin: 50px;"><b>ä¼šè®®å®¤é¢„å®š</b></h1>
    <div class="form-group col-lg-4 col-lg-offset-8">
        <div class="col-lg-9">
            <input type="text" class="form-control" id="date" placeholder="" style="height: 40px;text-align: center">
            <div id='schedule-box' class="boxshaw pull-right"></div>
        </div>
        <button class="btn  btn-default col-lg-3 " style="height: 40px">é¢„å®š</button>
    </div>

    <table class="table table-bordered">
        <thead>
        <tr>
            <th>ä¼šè®®å®¤</th>
            {% for times in time_choices %}
                <th>{{ times.1 }}</th>
            {% endfor %}

        </tr>
        </thead>
        <tbody id="tBody">

        </tbody>
    </table>
</div>
<script src="{% static 'js/jquery-1.12.4.min.js' %}"></script>
<script src="{% static 'js/jquery.cookie.js' %}"></script>
<script src="{% static 'plugins/schedule/schedule.js' %}"></script>
<script>
    var mySchedule = new Schedule({
        el: '#schedule-box',
        //date: '2018-9-20',
        clickCb: function (y, m, d) {
            console.log('66666');
            document.querySelector('#date').value = y + '-' + m + '-' + d
        },
        nextMonthCb: function (y, m, d) {
            document.querySelector('#date').value = y + '-' + m + '-' + d
        },
        nextYeayCb: function (y, m, d) {
            document.querySelector('#date').value = y + '-' + m + '-' + d
        },
        prevMonthCb: function (y, m, d) {
            document.querySelector('#date').value = y + '-' + m + '-' + d
        },
        prevYearCb: function (y, m, d) {
            document.querySelector('#date').value = y + '-' + m + '-' + d
        }
    });
</script>
<script>
    {#    éšè—æ˜¾ç¤ºæ’ä»¶#}
    $(function () {
        $("#date").val($(".today").html());
        $("#schedule-box").hide();
        $("#date").focus(function () {
            $("#schedule-box").slideDown()
        });
        $(document).click(function () {
            $("#schedule-box").slideUp()
        });
        $("#schedule-box,#date").click(function (event) {
            event.stopPropagation();
        });
    })


</script>


<script>

    $(function () {
        getBookInfo($('#date').val());
        console.log()
    });

    //è·å–é¢„å®šä¿¡æ¯
    function getBookInfo(data) {
        $.ajax({
            url: '/booking/',
            type: 'GET',
            data: {'date': data},
            success: function (arg) {
                arg = JSON.parse(arg);
                if (arg.status) {
                    $.each(arg.data, function (i, item) {
                        var tr = document.createElement('tr'); //åˆ›å»ºtræ ‡ç­¾
                        $.each(item, function (j, v) {
                            {#console.log('v===',v);#}
                            //{title: "ğŸ’©", attrs: {room_id: 3, book_time: 12}}
                            var td = document.createElement('td');
                            $(td).text(v.title);
                            {#console.log(td)  //<td>å–”</td>#}
                            {#console.log(v.attrs)#}
                            $.each(v.attrs, function (kk, vv) {
                                $(td).attr(kk, vv);  //kkæŒ‡çš„å°±æ˜¯éå†æ‰€æœ‰çš„k,vvå°±æ˜¯éå†æ‰€æœ‰çš„v
                                {#console.log(td)#}
                            });
                            $(tr).append(td)
                        });
                        $('#tBody').append(tr)
                    })
                    /*
                    <tr>
                        <td>ä¼šè®®å®¤å</td>
                        <td></td>
                        <td>ä¼šè®®å®¤å</td>
                    </tr>
                    * */
                }
            }
        })
    }


    //å®šä¹‰ä¸€ä¸ªå…¨å±€å˜é‡,ç”¨æ¥å­˜æ”¾å¢åŠ åˆ é™¤çš„é€‰é¡¹
    POST_DATA = {
        ADD: {},
        DEL: {}
    };

    //ç»™tdç»‘å®šäº‹ä»¶,è®©é¡µé¢å¯ä»¥åŠ¨èµ·æ¥,tdåœ¨æœ€åˆæ˜¯æ²¡æœ‰çš„,æ‰€ä»¥äº‹ä»¶ç»‘å®š
    //ä¼šè®®å®¤åå’Œéè‡ªå·±é¢„å®šçš„ æ˜¯ä¸éœ€è¦äº‹ä»¶çš„.å¾—ç‚¹ä¸åŠ¨
    // tdä¸‹é¢çš„ä¸ä»…æ‹¥æœ‰room_idå±æ€§,å¹¶ä¸”fuckä¸ç­‰äºtrueçš„
    $('#tBody').on('click', 'td[room_id][fuck!="true"]', function () {
        var room_id = $(this).attr('room_id');
        var book_time = $(this).attr('book_time');
        if ($(this).hasClass('chosen')) {
            $(this).removeClass('chosen');
            $(this).empty().html('ğŸ¤–');

            if (POST_DATA.DEL[room_id]) {
                POST_DATA.DEL[room_id].push(book_time)
            } else {
                POST_DATA.DEL[room_id] = [book_time]
            }  // è¿™é‡ŒDEL[room_id]å¯¹åº”çš„å€¼åº”è¯¥æ˜¯ä¸€ä¸ªåˆ—è¡¨.ä¾‹å¦‚{ä¼šè®®å®¤1:[1,2]}
        }

        else if ($(this).hasClass('after_click')) {
            $(this).removeClass('after_click');
            // åœ¨ADDä¸­æ‰¾åˆ°å¹¶åˆ é™¤.å®ƒæ˜¯åæ¥ç‚¹å‡»çš„,é»˜è®¤æ˜¯æ²¡æœ‰çš„.èƒ½èµ°åˆ°è¿™è¯´æ˜æ˜¯å…ˆç‚¹å‡»ååˆå–æ¶ˆçš„.æ‰€ä»¥ADDé‡Œé¢è‚¯å®šæœ‰
            var index = POST_DATA.ADD[room_id].indexOf(book_time);
            if(index !== -1 ){POST_DATA.ADD[room_id].splice(index,1)}
        }
        else {
            $(this).addClass('after_click');

            if (POST_DATA.ADD[room_id]) {
                POST_DATA.ADD[room_id].push(book_time)
            } else {
                POST_DATA.ADD[room_id] = [book_time]
            }
        }
    })

</script>

</body>
</html>